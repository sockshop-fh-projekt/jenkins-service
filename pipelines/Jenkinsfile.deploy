@Library('dynatrace@master') _

def tagMatchRules = [
  [
    meTypes: [
      [meType: 'SERVICE']
    ],
    tags : [
      [context: 'ENVIRONMENT', key: 'application', value: ''],
      [context: 'CONTEXTLESS', key: 'service', value: ''],
      [context: 'CONTEXTLESS', key: 'environment', value: '']
    ]
  ]
]

def IMAGE_TAG = 'UNKNOWN'
def PULL_REQUEST = 'UNKNOWN'
def STABLE_TAG = 'UNKNOWN'

pipeline {
  parameters {
    string(name: 'GITHUBORG', defaultValue: 'sockshop-fh-projekt', description: 'The name of the GitHub organization.', trim: true)
    string(name: 'PROJECT', defaultValue: 'sockshop', description: 'The name of the entire project.', trim: true)
    string(name: 'TESTSTRATEGY', defaultValue: 'performance', description: 'The test strategy for this stage.', trim: true)
    string(name: 'DEPLOYMENTSTRATEGY', defaultValue: 'blue_green_mirroring', description: 'The deployment strategy for this stage.', trim: true)
    string(name: 'STAGE', defaultValue: 'staging', description: 'The stage to deploy the service to.', trim: true)
    string(name: 'SERVICE', defaultValue: 'carts', description: 'The name of the service to deploy.', trim: true)
    string(name: 'IMAGE', defaultValue: '10.31.253.242:5000/sockshop/carts', description: 'The image of the new service.', trim: true)
    string(name: 'TAG', defaultValue: '0.6.0-1', description: 'The tag of the new service.', trim: true)
    string(name: 'KEPTNCONTEXT', defaultValue: '9812323nhafh', description: 'An id used for keptn tracing', trim: true)
  }
  agent {
    label 'kubegit'
  }
  stages {
    stage('Deploy service - direct') {
      when {
        expression {
          return env.DEPLOYMENTSTRATEGY ==~ 'direct' 
        }
      }
      steps {
        container('git') {
          withCredentials([usernamePassword(credentialsId: 'git-credentials-acm', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh "rm -rf ${env.PROJECT}"
            sh "git config --global user.email ${env.GITHUB_USER_EMAIL}"
            sh "git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/${env.GITHUBORG}/${env.PROJECT}"
            sh "cd ${env.PROJECT} && git checkout ${env.STAGE}"
          }
        }
        container('helm') {
          script {
            sh "helm init --client-only"
            sh "cd ${env.PROJECT} && helm dep update helm-chart/"
            sh "cd ${env.PROJECT} && helm upgrade --install ${env.PROJECT}-${env.STAGE} ./helm-chart --namespace ${env.PROJECT}-${env.STAGE} --wait"
          }
        }
      }
    }
    stage('Deploy service - mirroring') {
      when {
        expression {
          return env.DEPLOYMENTSTRATEGY ==~ 'blue_green_mirroring' 
        }
      }
      steps {
        container("git") {
          withCredentials([usernamePassword(credentialsId: 'git-credentials-acm', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh "rm -rf ${env.PROJECT}"
            sh "git config --global user.email ${env.GITHUB_USER_EMAIL}"
            sh "git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/${env.GITHUBORG}/${env.PROJECT}"
            sh "cd ${env.PROJECT} && git checkout ${env.STAGE}"

            sh "cd ${env.PROJECT} && sed -i \"/-/{x;s/.*/&_/;/^_______\$/{x;d;};x;}\" helm-chart/templates/${env.SERVICE}-istio-virtual-service.yaml"
            sh "cd ${env.PROJECT} && sed -i \"/destination/{x;s/.*/&_/;/^__\$/{x;d;};x;}\" helm-chart/templates/${env.SERVICE}-istio-virtual-service.yaml"            
            
            sh "cd ${env.PROJECT} && sed -i \"s/        host:\\(.*\\)#m/host:\\1#m/\" helm-chart/templates/${env.SERVICE}-istio-virtual-service.yaml"
            sh "cd ${env.PROJECT} && sed -i \"s/        subset:\\(.*\\)#m/subset:\\1#m/\" helm-chart/templates/${env.SERVICE}-istio-virtual-service.yaml"
            sh "cd ${env.PROJECT} && sed -i \"s/weight: 0/#marker/\" helm-chart/templates/${env.SERVICE}-istio-virtual-service.yaml"

            sh "cd ${env.PROJECT} && sed -i \"/weight: 100/{p;s/.*/            mirror:/;}\" helm-chart/templates/${env.SERVICE}-istio-virtual-service.yaml" 

            sh "cd ${env.PROJECT} && git add ."
            sh "cd ${env.PROJECT} && git commit -am '[keptn]: Added mirroring'"
            sh "cd ${env.PROJECT} && git push"
          }
        }
        container('helm') {
          script {
            sh "helm init --client-only"
            sh "cd ${env.PROJECT} && helm dep update helm-chart/"
            sh "cd ${env.PROJECT} && helm upgrade --install ${env.PROJECT}-${env.STAGE} ./helm-chart --namespace ${env.PROJECT}-${env.STAGE} --wait"
          }
        }
      }
    }
    stage('Deploy service - blue/green') {
      when {
        expression {
          return env.DEPLOYMENTSTRATEGY ==~ 'blue_green_service' 
        }
      }
      steps {
        container('git') {
          withCredentials([usernamePassword(credentialsId: 'git-credentials-acm', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh "rm -rf ${env.PROJECT}"
            sh "git config --global user.email ${env.GITHUB_USER_EMAIL}"
            sh "git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/${env.GITHUBORG}/${env.PROJECT}"
            sh "cd ${env.PROJECT} && git checkout ${env.STAGE}"
            sh "cd ${env.PROJECT} && git reset --hard HEAD~1"
          }
        }
        container('helm') {    
          script {
            sh "helm init --client-only"
            sh "cd ${env.PROJECT} && helm dep update helm-chart/"
            sh "cd ${env.PROJECT} && helm upgrade --install ${env.PROJECT}-${env.STAGE} ./helm-chart --namespace ${env.PROJECT}-${env.STAGE} --wait"
          }
        }
        container('kubectl') {    
          script {
            sh "kubectl rollout status deployment/" + "${env.SERVICE}" + "-blue" + " --namespace " + "${env.PROJECT}-${env.STAGE}"
            sh "kubectl rollout status deployment/" + "${env.SERVICE}" + "-green" + " --namespace " + "${env.PROJECT}-${env.STAGE}"
          }
        }
        container('git') {
          withCredentials([usernamePassword(credentialsId: 'git-credentials-acm', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh "cd ${env.PROJECT} && git reset --hard 'HEAD@{1}'"
          }
        }
        container('helm') {    
          script {            
            sh "cd ${env.PROJECT} && helm upgrade --install ${env.PROJECT}-${env.STAGE} ./helm-chart --namespace ${env.PROJECT}-${env.STAGE} --wait"
          }
        }
      }
    }
    stage('Send keptn event') {
      steps {
        container("curl") {
          sendCloudEvent(
            receiver: 'event-broker.keptn.svc.cluster.local/keptn',
            type: 'sh.keptn.events.deployment-finished',
            source: 'Jenkins',
            shkeptncontext : "${env.KEPTNCONTEXT}",
            data: [
              [key: 'githuborg', value: "${env.GITHUBORG}"],
              [key: 'project', value: "${env.PROJECT}"],
              [key: 'teststrategy', value: "${env.TESTSTRATEGY}"],
              [key: 'deploymentstrategy', value: "${env.DEPLOYMENTSTRATEGY}"],
              [key: 'stage', value: "${env.STAGE}"],
              [key: 'service', value: "${env.SERVICE}"],
              [key: 'image', value: "${env.IMAGE}"],
              [key: 'tag', value: "${env.TAG}"]
            ]
          )
        }
      }
    }
  }
}
